<div class="sv-page__wrap sv-page__wrap--center">
  <header class="sv-page__header flex row flex-space-between align-items-center">
    <div>
      <h2 class="sv-page__title">Settings</h2>
      <p class="sv-page__subtitle">
        Manage preferences, integrations, and policies across your platfrom.
      </p>
    </div>
  </header>

  <nav class="sv-breadcrumb" aria-label="Breadcrumb">
    <ol class="sv-breadcrumb__list">
      <li class="sv-breadcrumb__item">
        <a class="sv-breadcrumb__link" href="/">Home</a>
      </li>
      <li class="sv-breadcrumb__item" aria-current="page">
        <span class="sv-breadcrumb__current">Settings</span>
      </li>
    </ol>
  </nav>

  <section class="sv-grid col">
    <!-- App settings -->
    <article class="sv-card">
      <div class="sv-card__header"><strong>App Settings</strong></div>
      <div class="sv-card__body">
        <form id="app-form" class="sv-form sv-grid col gap-s">
          <div class="sv-form__field">
            <label class="label" for="appName">App Name</label>
            <input
              id="appName"
              class="input"
              type="text"
              placeholder="Sovereign"
              value="Sovereign"
            />
          </div>
          <div class="sv-form__field">
            <label class="label" for="appTagline">Tagline</label>
            <input
              id="appTagline"
              class="input"
              type="text"
              placeholder="Reclaim your digital freedom."
              value="Reclaim your digital freedom."
            />
          </div>

          <div class="sv-form__field">
            <label class="label" for="appDescription">Description</label>
            <textarea
              id="appDescription"
              class="input"
              rows="3"
              placeholder="A Sovereign application"
            >
A Sovereign application</textarea
            >
          </div>

          <div class="sv-form__field">
            <label class="label" for="baseUrl">Base URL</label>
            <input
              id="baseUrl"
              class="input"
              type="url"
              placeholder="https://example.com"
              value="https://example.com"
            />
          </div>
          <div class="sv-form__field">
            <label class="label" for="appVersion">App Version</label>
            <input id="appVersion" class="input" type="text" placeholder="0.1.0" value="0.1.0" />
          </div>

          <div class="sv-form__field">
            <label class="label" for="defaultUserRole">Default User Role</label>
            <input
              id="defaultUserRole"
              class="input"
              type="text"
              placeholder="guest"
              value="guest"
            />
          </div>
          <div class="sv-form__field">
            <label class="label" for="signupPolicy">Signup Policy</label>
            <select id="signupPolicy" class="input">
              <option value="invite" selected>Invite only</option>
              <option value="open">Open registration</option>
            </select>
          </div>

          <div class="sv-form__field">
            <label class="label" for="passwordMinLength">Password Min Length</label>
            <input id="passwordMinLength" class="input" type="number" min="4" value="8" />
          </div>
          <div class="sv-form__field">
            <label class="label" for="sessionTtlMs">Session TTL (ms)</label>
            <input
              id="sessionTtlMs"
              class="input"
              type="number"
              min="60000"
              step="60000"
              value="86400000"
            />
          </div>

          <div class="sv-form__field">
            <label class="label" for="cookieName">Session Cookie Name</label>
            <input
              id="cookieName"
              class="input"
              type="text"
              placeholder="svg_session"
              value="svg_session"
            />
          </div>
          <div class="sv-form__field">
            <label class="label" for="dateFormat">Date Format</label>
            <select id="dateFormat" class="input">
              <option value="locale" selected>System locale</option>
              <option value="iso">ISO 8601</option>
              <option value="ymd">YYYY-MM-DD HH:mm</option>
              <option value="mdy">MMM d, yyyy h:mm a</option>
            </select>
          </div>

          <div class="sv-form__field">
            <label class="label">Access & Compliance</label>
            <div class="flex row">
              <div class="sv-col-2">
                <label class="flex align-items-center flex-start">
                  <input id="allowGuest" class="sv-checkbox margin-right-xs" type="checkbox" />
                  <span>Enable guest mode</span>
                </label>
              </div>
              <div class="sv-col-2">
                <label class="flex align-items-center flex-start">
                  <input id="guestBypass" class="sv-checkbox margin-right-xs" type="checkbox" />
                  <span>Guest login bypass</span>
                </label>
              </div>
              <div class="sv-col-2">
                <label class="flex align-items-center flex-start">
                  <input id="requireTerms" class="sv-checkbox margin-right-xs" type="checkbox" />
                  <span>Require terms acceptance</span>
                </label>
              </div>
            </div>
          </div>

          <div class="sv-form__actions">
            <button id="save-app" class="button sv-button sv-button--primary" type="submit">
              Save changes
            </button>
            <button id="reset-app" class="button sv-button" type="button">Reset</button>
          </div>
        </form>
      </div>
    </article>

    <!-- Plugin controls -->
    <article class="sv-card">
      <div class="sv-card__header"><strong>Plugins</strong></div>
      <div class="sv-card__body">
        <p class="sv-card__subtitle">Enable plugins and toggle dev-only access.</p>
        <div class="sv-table__wrap">
          <table class="sv-table">
            <thead>
              <tr>
                <th class="text-left">Plugin</th>
                <th class="text-left">Namespace</th>
                <th class="text-left">Type</th>
                <th>Enabled</th>
                <th>Dev Only</th>
              </tr>
            </thead>
            <tbody id="plugin-table-body">
              <tr>
                <td colspan="5" class="text-center">Loading plugins...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="sv-form__actions margin-top-s">
          <button id="save-plugins" class="button sv-button sv-button--primary" type="button">
            Save plugins
          </button>
          <button id="reset-plugins" class="button sv-button" type="button">Reset</button>
        </div>
      </div>
    </article>

    <!-- Email -->
    <article class="sv-card">
      <div class="sv-card__header"><strong>Email Settings</strong></div>
      <div class="sv-card__body">
        <form id="email-form" class="sv-form sv-grid col gap-s">
          <div class="sv-form__field">
            <label class="label" for="emailFromName">From Name</label>
            <input id="emailFromName" class="input" type="text" placeholder="Sovereign" />
          </div>
          <div class="sv-form__field">
            <label class="label" for="emailFromAddress">From Address</label>
            <input
              id="emailFromAddress"
              class="input"
              type="email"
              placeholder="no-reply@example.com"
            />
          </div>

          <div class="sv-form__field">
            <label class="label" for="emailReplyTo">Reply-To</label>
            <dv>
              <input
                id="emailReplyTo"
                class="input"
                type="email"
                placeholder="support@example.com"
              />
              <span class="form__field-helptext sv-form__field-helptext">
                Optional: leave blank to use the From address.
              </span>
            </dv>
          </div>
          <div class="sv-form__field">
            <label class="label">Delivery</label>
            <label>
              <input id="emailBypass" type="sv-checkbox" />
              <span>Bypass outbound email (log only)</span>
            </label>
          </div>

          <div class="sv-form__field">
            <label class="label" for="smtpUrl">SMTP URL</label>
            <div>
              <input
                id="smtpUrl"
                class="input"
                type="text"
                placeholder="smtps://user:pass@mail.example.com:465"
              />
              <span class="form__field-helptext sv-form__field-helptext">
                Optional: overrides host/port/user fields when provided.
              </span>
            </div>
          </div>

          <div class="sv-form__field">
            <label class="label" for="smtpHost">SMTP Host</label>
            <input id="smtpHost" class="input" type="text" placeholder="mail.example.com" />
          </div>
          <div class="sv-form__field">
            <label class="label" for="smtpPort">SMTP Port</label>
            <input id="smtpPort" class="input" type="number" min="1" step="1" placeholder="587" />
          </div>

          <div class="sv-form__field">
            <label class="label" for="smtpUser">SMTP Username</label>
            <input id="smtpUser" class="input" type="text" placeholder="smtp-user" />
          </div>

          <div class="sv-form__field">
            <label class="label" for="smtpPassword">SMTP Password</label>
            <input
              id="smtpPassword"
              class="input"
              type="password"
              autocomplete="new-password"
              placeholder="••••••••"
            />
          </div>

          <div class="sv-form__field">
            <label class="label">Security</label>
            <div class="flex row">
              <div class="sv-col-3">
                <label class="flex align-items-center flex-start">
                  <input id="smtpSecure" class="sv-checkbox margin-right-xs" type="checkbox" />
                  <span>Use secure connection (TLS/SSL)</span>
                </label>
              </div>
              <div class="sv-col-3">
                <label class="flex align-items-center flex-start">
                  <input id="smtpIgnoreTls" class="sv-checkbox margin-right-xs" type="checkbox" />
                  <span>Ignore TLS certificate validation</span>
                </label>
              </div>
            </div>
          </div>

          <div class="sv-form__actions">
            <button class="button sv-button--primary" type="submit">Save changes</button>
            <button id="reset-email" class="button" type="button">Reset</button>
          </div>
        </form>
      </div>
    </article>

    <!-- Localization -->
    <article class="sv-card">
      <div class="sv-card__header"><strong>Localization</strong></div>
      <div class="sv-card__body">
        <form id="loc-form" class="sv-form sv-grid col gap-s">
          <div class="sv-form__field">
            <label class="label" for="defaultLocale">Default Locale</label>
            <select id="defaultLocale" class="input" data-default="en-US">
              <option value="en-US" selected>English (US)</option>
              <option value="en-GB">English (UK)</option>
              <!-- <option value="en-CA">English (Canada)</option>
                    <option value="fr-FR">French (France)</option>
                    <option value="de-DE">German (Germany)</option>
                    <option value="es-ES">Spanish (Spain)</option>
                    <option value="es-MX">Spanish (Mexico)</option>
                    <option value="pt-BR">Portuguese (Brazil)</option>
                    <option value="ja-JP">Japanese</option> -->
            </select>
          </div>
          <div class="sv-form__field">
            <label class="label" for="defaultCurrency">Default Currency</label>
            <input
              id="defaultCurrency"
              class="input"
              type="text"
              placeholder="USD"
              value="USD"
              data-default="USD"
              readonly
            />
          </div>

          <div class="sv-form__field">
            <label class="label" for="supportedLocales">Supported Locales</label>
            <div>
              <textarea
                id="supportedLocales"
                class="input"
                rows="2"
                placeholder="en-US,en-GB"
                data-default="en-US,en-GB"
                readonly
              >
                    en-US
                  </textarea
              >
              <span class="form__field-helptext sv-form__field-helptext">
                Comma separated list of locale codes.
              </span>
            </div>
          </div>

          <div class="sv-form__field">
            <label class="label" for="timeZone">Time Zone</label>
            <div>
              <select id="timeZone" class="input" data-default="UTC">
                <option value="UTC" selected>UTC</option>
                <!-- <option value="Europe/London">Europe/London</option>
                    <option value="Europe/Berlin">Europe/Berlin</option>
                    <option value="Europe/Paris">Europe/Paris</option>
                    <option value="America/New_York">America/New_York</option>
                    <option value="America/Los_Angeles">
                      America/Los_Angeles
                    </option>
                    <option value="Asia/Colombo">Asia/Colombo</option>
                    <option value="Asia/Kolkata">Asia/Kolkata</option>
                    <option value="Asia/Tokyo">Asia/Tokyo</option>
                    <option value="Australia/Sydney">Australia/Sydney</option> -->
              </select>
              <span class="form__field-helptext sv-form__field-helptext">
                Used for displaying dates/times across the app.
              </span>
            </div>
          </div>

          <div class="sv-form__actions">
            <button id="save-loc" class="button sv-button sv-button--primary" type="submit">
              Save changes
            </button>
            <button id="reset-loc" class="button" type="button">Reset</button>
          </div>
        </form>
      </div>
    </article>
  </section>
</div>
<script>
  const SETTINGS_FIELD_MAP = {
    "env.app.name": { id: "appName" },
    "env.app.tagline": { id: "appTagline" },
    "env.app.description": { id: "appDescription" },
    "env.app.version": { id: "appVersion" },
    "env.app.url": { id: "baseUrl" },
    "default.user.role": { id: "defaultUserRole" },
    "signup.policy": { id: "signupPolicy" },
    "auth.password.min_length": { id: "passwordMinLength" },
    "auth.session.ttl_ms": { id: "sessionTtlMs" },
    "auth.cookie.name": { id: "cookieName" },
    "feature.guest.login.enabled": { id: "allowGuest" },
    "feature.guest.login.enabled.bypass": { id: "guestBypass" },
    "feature.terms.require_acceptance": { id: "requireTerms" },
    "ui.date.format": { id: "dateFormat" },
    "feature.email.delivery.bypass": { id: "emailBypass" },
    "email.from.name": { id: "emailFromName" },
    "email.from.address": { id: "emailFromAddress" },
    "email.reply_to": { id: "emailReplyTo" },
    "email.smtp.url": { id: "smtpUrl" },
    "email.smtp.host": { id: "smtpHost" },
    "email.smtp.port": { id: "smtpPort" },
    "email.smtp.secure": { id: "smtpSecure" },
    "email.smtp.ignore_tls": { id: "smtpIgnoreTls" },
    "email.smtp.user": { id: "smtpUser" },
    "email.smtp.password": {
      id: "smtpPassword",
      toInput: (value) => (value === null || value === undefined ? "" : value),
    },
    "env.locale.default": { id: "defaultLocale" },
    "env.locale.supported": {
      id: "supportedLocales",
      toInput: (value) => (Array.isArray(value) ? value.join(",") : String(value ?? "")),
    },
    "env.currency.default": {
      id: "defaultCurrency",
      toInput: (value) => (typeof value === "string" ? value.toUpperCase() : String(value ?? "")),
    },
    "env.timezone.default": { id: "timeZone" },
  };

  const LOCALE_PATTERN = /^[a-z]{2,3}(?:[-_][a-z0-9]+)*$/i;
  const EMAIL_PATTERN = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  function normalizeLocaleInput(value) {
    if (value === null || value === undefined) return "";
    const raw = String(value).trim();
    if (!raw) return "";
    const normalized = raw.replace(/_/g, "-");
    if (!LOCALE_PATTERN.test(normalized)) return null;
    const segments = normalized.split("-");
    const base = segments.shift().toLowerCase();
    const formatted = segments.map((segment) => {
      if (!segment) return segment;
      if (segment.length <= 2) return segment.toUpperCase();
      return segment[0].toUpperCase() + segment.slice(1);
    });
    return [base, ...formatted].filter(Boolean).join("-");
  }

  function toBoolean(value) {
    if (typeof value === "boolean") return value;
    if (typeof value === "number") return value !== 0;
    if (typeof value === "string") {
      const normalized = value.trim().toLowerCase();
      return ["true", "1", "yes", "on"].includes(normalized);
    }
    return Boolean(value);
  }

  function setFieldValue(id, rawValue, config = {}) {
    const field = document.getElementById(id);
    if (!field) return;

    const value = typeof config.toInput === "function" ? config.toInput(rawValue) : rawValue;

    if (field.type === "checkbox") {
      field.checked = toBoolean(value);
      return;
    }

    if (field.tagName === "SELECT") {
      const selectValue = Array.isArray(value) ? String(value[0] ?? "") : (value ?? "");
      if (typeof selectValue === "string" && selectValue) {
        const hasOption = Array.from(field.options).some((opt) => opt.value === selectValue);
        if (!hasOption) {
          const opt = document.createElement("option");
          opt.value = selectValue;
          opt.textContent = selectValue;
          field.appendChild(opt);
        }
        field.value = selectValue;
      }
      return;
    }

    if (field.type === "number") {
      if (value === null || value === undefined || value === "") {
        field.value = "";
        return;
      }
      const num = Number(value);
      if (!Number.isNaN(num)) {
        field.value = num;
      }
      return;
    }

    if (field.tagName === "TEXTAREA") {
      field.value = value ?? "";
      return;
    }

    field.value = value ?? "";
  }

  const pluginTableBody = document.getElementById("plugin-table-body");
  const savePluginsBtn = document.getElementById("save-plugins");
  const resetPluginsBtn = document.getElementById("reset-plugins");
  let pluginState = [];
  let pluginInitialState = [];

  function clonePlugins(list = []) {
    return list.map((p) => ({ ...p }));
  }

  function renderPlugins(list = []) {
    if (!pluginTableBody) return;
    pluginTableBody.innerHTML = "";
    if (!list.length) {
      const row = document.createElement("tr");
      row.innerHTML = `<td colspan="5" class="text-center">No plugins found.</td>`;
      pluginTableBody.appendChild(row);
      return;
    }

    for (const plugin of list) {
      const row = document.createElement("tr");
      row.dataset.pluginId = plugin.pluginId;
      row.dataset.namespace = plugin.namespace;
      row.innerHTML = `
        <td>
          <div class="text-strong">${plugin.name || plugin.pluginId}</div>
          <div class="text-small text-muted">${plugin.pluginId}</div>
        </td>
        <td>${plugin.namespace || "—"}</td>
        <td>${plugin.type || "module"}</td>
        <td class="text-center">
          <input
            type="checkbox"
            class="sv-checkbox plugin-enabled"
            ${plugin.enabled ? "checked" : ""}
            ${plugin.corePlugin ? "disabled" : ""}
          />
        </td>
        <td class="text-center">
          <input
            type="checkbox"
            class="sv-checkbox plugin-devonly"
            ${plugin.devOnly ? "checked" : ""}
            ${plugin.corePlugin ? "disabled" : ""}
          />
        </td>
      `;
      pluginTableBody.appendChild(row);
    }
  }

  async function loadPlugins() {
    if (!pluginTableBody) return;
    try {
      const res = await fetch("/api/plugins/settings/plugins");
      if (!res.ok) {
        throw new Error(`Failed to load plugins (status ${res.status})`);
      }
      const data = await res.json();
      pluginState = clonePlugins(data?.plugins || []);
      pluginInitialState = clonePlugins(pluginState);
      renderPlugins(pluginState);
    } catch (err) {
      console.error("Failed to load plugins", err);
      pluginTableBody.innerHTML = `<tr><td colspan="5" class="text-center">Failed to load plugins.</td></tr>`;
    }
  }

  function collectPluginFormState() {
    const rows = Array.from(pluginTableBody?.querySelectorAll("tr[data-plugin-id]") || []);
    return rows.map((row) => {
      const pluginId = row.dataset.pluginId;
      const namespace = row.dataset.namespace;
      const enabled = row.querySelector(".plugin-enabled")?.checked ?? false;
      const devOnly = row.querySelector(".plugin-devonly")?.checked ?? false;
      const base = pluginState.find((p) => p.pluginId === pluginId) || {};
      return { ...base, pluginId, namespace, enabled, devOnly };
    });
  }

  async function savePlugins() {
    if (!savePluginsBtn) return;
    savePluginsBtn.disabled = true;
    savePluginsBtn.dataset.prevText = savePluginsBtn.textContent;
    savePluginsBtn.textContent = "Saving...";
    try {
      const current = collectPluginFormState();
      const res = await fetch("/api/plugins/settings/plugins", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ plugins: current }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        const msg = data?.error || "Failed to save plugins";
        const details =
          Array.isArray(data?.details) && data.details.length ? `\n${data.details.join("\n")}` : "";
        throw new Error(`${msg}${details}`);
      }
      pluginState = clonePlugins(data?.plugins || current);
      pluginInitialState = clonePlugins(pluginState);
      renderPlugins(pluginState);
      alert("Plugins updated.");
    } catch (err) {
      console.error(err);
      alert(err?.message || "Failed to update plugins.");
    } finally {
      savePluginsBtn.disabled = false;
      savePluginsBtn.textContent = savePluginsBtn.dataset.prevText || savePluginsBtn.textContent;
      delete savePluginsBtn.dataset.prevText;
    }
  }

  function resetPlugins() {
    pluginState = clonePlugins(pluginInitialState);
    renderPlugins(pluginState);
  }

  if (pluginTableBody) {
    pluginTableBody.addEventListener("change", (e) => {
      const row = e.target.closest("tr[data-plugin-id]");
      if (!row) return;
      const pluginId = row.dataset.pluginId;
      const target = pluginState.find((p) => p.pluginId === pluginId);
      if (!target) return;
      if (e.target.classList.contains("plugin-enabled")) {
        target.enabled = e.target.checked;
      }
      if (e.target.classList.contains("plugin-devonly")) {
        target.devOnly = e.target.checked;
      }
    });
  }

  savePluginsBtn?.addEventListener("click", savePlugins);
  resetPluginsBtn?.addEventListener("click", resetPlugins);

  async function loadSettings() {
    try {
      const res = await fetch("/api/plugins/settings");
      if (!res.ok) {
        throw new Error(`Failed to load settings (status ${res.status})`);
      }
      const data = await res.json();
      const settings = data?.settings || {};

      for (const [key, config] of Object.entries(SETTINGS_FIELD_MAP)) {
        if (!(key in settings)) continue;
        setFieldValue(config.id, settings[key], config);
      }
    } catch (err) {
      console.error("Failed to load settings", err);
    }
  }

  function markFieldError(field, hasError) {
    if (!field) return;
    field.classList.toggle("input--error", hasError);
    const messageEl = field.parentElement?.querySelector(".help.help--error");
    if (messageEl) {
      messageEl.style.display = hasError ? "block" : "none";
    }
  }

  function validateAppForm() {
    const errors = [];

    const nameField = document.getElementById("appName");
    const nameValue = nameField.value.trim();
    markFieldError(nameField, false);
    if (!nameValue) {
      errors.push("App name is required.");
      markFieldError(nameField, true);
    } else {
      nameField.value = nameValue;
    }

    const urlField = document.getElementById("baseUrl");
    const urlValue = urlField.value.trim();
    markFieldError(urlField, false);
    if (urlValue && !/^https?:\/\/[^ ]+$/i.test(urlValue)) {
      errors.push("Base URL must be a valid http(s) URL.");
      markFieldError(urlField, true);
    } else {
      urlField.value = urlValue;
    }

    const passwordField = document.getElementById("passwordMinLength");
    const passValue = Number(passwordField.value);
    markFieldError(passwordField, false);
    if (!Number.isFinite(passValue) || passValue < 4) {
      errors.push("Password minimum length must be at least 4.");
      markFieldError(passwordField, true);
    } else {
      passwordField.value = String(Math.floor(passValue));
    }

    const ttlField = document.getElementById("sessionTtlMs");
    const ttlValue = Number(ttlField.value);
    markFieldError(ttlField, false);
    if (!Number.isFinite(ttlValue) || ttlValue < 60000) {
      errors.push("Session TTL must be at least 60000 ms (1 minute).");
      markFieldError(ttlField, true);
    } else {
      ttlField.value = String(Math.floor(ttlValue));
    }

    const cookieField = document.getElementById("cookieName");
    const cookieValue = cookieField.value.trim();
    markFieldError(cookieField, false);
    if (!cookieValue) {
      errors.push("Session cookie name is required.");
      markFieldError(cookieField, true);
    } else {
      cookieField.value = cookieValue;
    }

    return errors;
  }

  function validateLocalizationForm() {
    const errors = [];

    const currencyField = document.getElementById("defaultCurrency");
    const currencyValue = currencyField.value.trim();
    markFieldError(currencyField, false);
    if (!currencyValue || currencyValue.length !== 3) {
      errors.push("Default currency must be a 3-letter ISO code.");
      markFieldError(currencyField, true);
    } else {
      currencyField.value = currencyValue.toUpperCase();
    }

    const defaultLocaleField = document.getElementById("defaultLocale");
    markFieldError(defaultLocaleField, false);
    const normalizedDefaultLocale = normalizeLocaleInput(defaultLocaleField.value);
    if (!normalizedDefaultLocale) {
      errors.push("Default locale must be a valid locale code (e.g., en-US).");
      markFieldError(defaultLocaleField, true);
    } else {
      defaultLocaleField.value = normalizedDefaultLocale;
    }

    const supportedField = document.getElementById("supportedLocales");
    markFieldError(supportedField, false);
    const rawLocales = supportedField.value
      .split(",")
      .map((s) => s.trim())
      .filter(Boolean);

    const normalizedLocales = [];
    const invalidLocales = [];

    for (const locale of rawLocales) {
      const normalized = normalizeLocaleInput(locale);
      if (!normalized) {
        invalidLocales.push(locale);
      } else {
        normalizedLocales.push(normalized);
      }
    }

    if (invalidLocales.length > 0) {
      errors.push(`Invalid locale codes: ${invalidLocales.join(", ")}`);
      markFieldError(supportedField, true);
    } else if (normalizedLocales.length > 0) {
      supportedField.value = normalizedLocales.join(",");
    }

    return errors;
  }

  function validateEmailForm() {
    const errors = [];

    const fromAddressField = document.getElementById("emailFromAddress");
    const fromAddress = fromAddressField.value.trim();
    markFieldError(fromAddressField, false);
    if (fromAddress && !EMAIL_PATTERN.test(fromAddress)) {
      errors.push("From address must be a valid email address.");
      markFieldError(fromAddressField, true);
    } else {
      fromAddressField.value = fromAddress;
    }

    const replyToField = document.getElementById("emailReplyTo");
    const replyTo = replyToField.value.trim();
    markFieldError(replyToField, false);
    if (replyTo && !EMAIL_PATTERN.test(replyTo)) {
      errors.push("Reply-To address must be a valid email address.");
      markFieldError(replyToField, true);
    } else {
      replyToField.value = replyTo;
    }

    const smtpUrlField = document.getElementById("smtpUrl");
    const smtpUrl = smtpUrlField.value.trim();
    markFieldError(smtpUrlField, false);
    if (smtpUrl && !/^smtps?:\/\//i.test(smtpUrl)) {
      errors.push("SMTP URL must start with smtp:// or smtps://.");
      markFieldError(smtpUrlField, true);
    } else {
      smtpUrlField.value = smtpUrl;
    }

    const smtpPortField = document.getElementById("smtpPort");
    const smtpPortRaw = smtpPortField.value.trim();
    markFieldError(smtpPortField, false);
    if (smtpPortRaw) {
      const smtpPort = Number.parseInt(smtpPortRaw, 10);
      if (!Number.isFinite(smtpPort) || smtpPort < 1) {
        errors.push("SMTP port must be a positive integer.");
        markFieldError(smtpPortField, true);
      } else {
        smtpPortField.value = String(smtpPort);
      }
    } else {
      smtpPortField.value = "";
    }

    return errors;
  }

  async function sendSettings(entries, submitter, successMessage) {
    if (!Array.isArray(entries) || entries.length === 0) return;
    if (submitter) {
      submitter.dataset.prevText = submitter.textContent;
      submitter.textContent = "Saving...";
      submitter.disabled = true;
    }

    try {
      const res = await fetch("/api/plugins/settings", {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ settings: entries }),
      });

      let data = null;
      try {
        data = await res.json();
      } catch (err) {
        // Ignore JSON parsing errors; we'll show generic message below if needed.
      }

      if (!res.ok) {
        const errMsg = (data && data.error) || `Failed to save settings (status ${res.status})`;
        const details =
          Array.isArray(data?.details) && data.details.length ? `\n${data.details.join("\n")}` : "";
        throw new Error(`${errMsg}${details}`);
      }

      alert(successMessage || "Settings saved.");
    } catch (err) {
      console.error("Failed to save settings", err);
      alert(err.message || "Failed to save settings.");
    } finally {
      if (submitter) {
        submitter.disabled = false;
        submitter.textContent = submitter.dataset.prevText || submitter.textContent;
        delete submitter.dataset.prevText;
      }
    }
  }

  document.getElementById("email-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.currentTarget;
    const submitter = e.submitter || form.querySelector('[type="submit"]');

    const errors = validateEmailForm();
    if (errors.length > 0) {
      alert(errors.join("\n"));
      return;
    }

    const fromName = document.getElementById("emailFromName").value.trim();
    const fromAddress = document.getElementById("emailFromAddress").value.trim();
    const replyTo = document.getElementById("emailReplyTo").value.trim();
    const bypass = document.getElementById("emailBypass").checked;
    const smtpUrl = document.getElementById("smtpUrl").value.trim();
    const smtpHost = document.getElementById("smtpHost").value.trim();
    const smtpPortRaw = document.getElementById("smtpPort").value.trim();
    const smtpPort = smtpPortRaw ? Number.parseInt(smtpPortRaw, 10) : null;
    const smtpSecure = document.getElementById("smtpSecure").checked;
    const smtpIgnoreTls = document.getElementById("smtpIgnoreTls").checked;
    const smtpUser = document.getElementById("smtpUser").value.trim();
    const smtpPassword = document.getElementById("smtpPassword").value;

    const entries = [
      { key: "email.from.name", value: fromName || null },
      { key: "email.from.address", value: fromAddress || null },
      { key: "email.reply_to", value: replyTo || null },
      { key: "feature.email.delivery.bypass", value: bypass },
      { key: "email.smtp.url", value: smtpUrl || null },
      { key: "email.smtp.host", value: smtpHost || null },
      {
        key: "email.smtp.port",
        value: smtpPort !== null && Number.isFinite(smtpPort) ? smtpPort : null,
      },
      { key: "email.smtp.secure", value: smtpSecure },
      { key: "email.smtp.ignore_tls", value: smtpIgnoreTls },
      { key: "email.smtp.user", value: smtpUser || null },
      {
        key: "email.smtp.password",
        value: smtpPassword && smtpPassword.length > 0 ? smtpPassword : null,
      },
    ];

    await sendSettings(entries, submitter, "Email settings saved.");
  });

  document.getElementById("app-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.currentTarget;
    const submitter = e.submitter || form.querySelector('[type="submit"]');

    const errors = validateAppForm();
    if (errors.length > 0) {
      alert(errors.join("\n"));
      return;
    }

    const appName = document.getElementById("appName").value.trim();
    const appTagline = document.getElementById("appTagline").value.trim();
    const appDescription = document.getElementById("appDescription").value.trim();
    const baseUrl = document.getElementById("baseUrl").value.trim();
    const appVersion = document.getElementById("appVersion").value.trim();
    const defaultUserRole = document.getElementById("defaultUserRole").value.trim();
    const signupPolicy = document.getElementById("signupPolicy").value || "invite";
    const passwordMinLengthRaw = Number.parseInt(
      document.getElementById("passwordMinLength").value,
      10
    );
    const passwordMinLength = Number.isFinite(passwordMinLengthRaw)
      ? Math.max(4, passwordMinLengthRaw)
      : 8;
    const sessionTtlRaw = Number.parseInt(document.getElementById("sessionTtlMs").value, 10);
    const sessionTtlMs = Number.isFinite(sessionTtlRaw)
      ? Math.max(60000, sessionTtlRaw)
      : 24 * 60 * 60 * 1000;
    const cookieName = document.getElementById("cookieName").value.trim();
    const allowGuest = document.getElementById("allowGuest").checked;
    const guestBypass = document.getElementById("guestBypass").checked;
    const requireTerms = document.getElementById("requireTerms").checked;
    const dateFormat = document.getElementById("dateFormat").value;

    const entries = [
      { key: "env.app.name", value: appName },
      { key: "env.app.tagline", value: appTagline || null },
      { key: "env.app.description", value: appDescription || null },
      { key: "env.app.version", value: appVersion || null },
      { key: "env.app.url", value: baseUrl || null },
      { key: "default.user.role", value: defaultUserRole || null },
      { key: "signup.policy", value: signupPolicy },
      { key: "auth.password.min_length", value: passwordMinLength },
      { key: "auth.session.ttl_ms", value: sessionTtlMs },
      { key: "auth.cookie.name", value: cookieName || "svg_session" },
      {
        key: "feature.guest.login.enabled",
        value: allowGuest,
      },
      {
        key: "feature.guest.login.enabled.bypass",
        value: guestBypass,
      },
      {
        key: "feature.terms.require_acceptance",
        value: requireTerms,
      },
      { key: "ui.date.format", value: dateFormat },
    ];

    await sendSettings(entries, submitter, "App settings saved.");
  });

  document.getElementById("loc-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.currentTarget;
    const submitter = e.submitter || form.querySelector('[type="submit"]');
    const errors = validateLocalizationForm();
    if (errors.length > 0) {
      alert(errors.join("\n"));
      return;
    }
    const defaultLocale = document.getElementById("defaultLocale").value;
    const supportedLocalesRaw = document.getElementById("supportedLocales").value;
    const supportedLocales = supportedLocalesRaw
      .split(",")
      .map((s) => s.trim())
      .filter(Boolean)
      .map((locale) => normalizeLocaleInput(locale))
      .filter(Boolean);
    const defaultCurrency = document.getElementById("defaultCurrency").value.trim().toUpperCase();
    const timeZone = document.getElementById("timeZone").value;

    const entries = [
      { key: "env.locale.default", value: defaultLocale },
      {
        key: "env.locale.supported",
        value: supportedLocales.length > 0 ? supportedLocales : [defaultLocale],
      },
      { key: "env.currency.default", value: defaultCurrency || "USD" },
      { key: "env.timezone.default", value: timeZone },
    ];

    await sendSettings(entries, submitter, "Localization saved.");
  });

  loadSettings();
  loadPlugins();

  // Reset buttons
  document.getElementById("reset-email").addEventListener("click", () => {
    window.location.reload();
  });
  document.getElementById("reset-app").addEventListener("click", () => {
    window.location.reload();
  });
  document.getElementById("reset-loc").addEventListener("click", () => {
    const localeSel = document.getElementById("defaultLocale");
    localeSel.value =
      localeSel.dataset.default || localeSel.querySelector("option[selected]")?.value || "en-US";
    const supportedInput = document.getElementById("supportedLocales");
    supportedInput.value = supportedInput.dataset.default || "en-US,en-GB";
    const currencyInput = document.getElementById("defaultCurrency");
    currencyInput.value = currencyInput.dataset.default || "USD";
    const sel = document.getElementById("timeZone");
    sel.value = sel.dataset.default || sel.querySelector("option[selected]")?.value || "UTC";
  });
</script>
