<style>
  /* TODO: Maybe we can get rif of this customization and use .sv-card with utility classes. */
  .sv-stats {
    margin: var(--space-l) 0;
    display: grid;
    gap: var(--space-m);
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }
  .sv-stats__card {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs);
    background: var(--color-surface);
    border: 1px solid var(--color-border-primary);
    border-radius: var(--radius-l);
    padding: var(--space-l);
    box-shadow: var(--shadow-s);
  }
  .sv-stats__card--label {
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .sv-stats__card--value {
    font-size: clamp(1.8rem, 1.3rem + 1vw, 2.4rem);
    line-height: 1.1;
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
  }
  .sv-stats__card--caption {
    font-size: var(--font-size-s);
    color: var(--color-text-secondary);
  }
  .users-table__plugins {
    display: flex;
    flex-direction: column;
    gap: var(--space-3xs);
  }
  .users-table__plugins-summary {
    color: var(--color-text-secondary);
    font-size: var(--font-size-s);
  }
  .users-table__plugins-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4xs);
    align-items: center;
  }
  @media (max-width: 960px) {
    .sv-stats {
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
  }
  @media (max-width: 700px) {
    .sv-stats {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
  }
  @media (max-width: 520px) {
    .sv-stats {
      margin: var(--space-m) 0;
      grid-template-columns: 1fr;
    }
  }
</style>
<div class="sv-page__wrap sv-page__wrap--center">
  {{> modal/modal-runtime}} {{> modal/create-user}} {{> modal/edit-user}}
  <header class="sv-page__header flex row flex-space-between align-items-center">
    <div>
      <h2 class="sv-page__title">Users</h2>
      <p class="sv-page__subtitle">Manage access, invitations, and roles across your workspace.</p>
    </div>
    <button class="sv-button sv-button--primary" type="button" data-modal-open="create-user">
      Invite user
    </button>
  </header>

  <nav class="sv-breadcrumb" aria-label="Breadcrumb">
    <ol class="sv-breadcrumb__list">
      <li class="sv-breadcrumb__item">
        <a class="sv-breadcrumb__link" href="/">Home</a>
      </li>
      <li class="sv-breadcrumb__item" aria-current="page">
        <span class="sv-breadcrumb__current">Users</span>
      </li>
    </ol>
  </nav>

  {{#if stats}}
  <section class="sv-stats" aria-label="Users overview">
    {{#each stats}}
    <article class="sv-stats__card">
      <span class="sv-stats__card--label">{{label}}</span>
      <span class="sv-stats__card--value">{{value}}</span>
      <span class="sv-stats__card--caption">{{caption}}</span>
    </article>
    {{/each}}
  </section>
  {{/if}}

  <section class="sv-card">
    <div class="sv-card__header sv-grid">
      <div class="sv-col-9">
        <strong>Directory</strong>
        <span>{{users.length}} people</span>
      </div>
      <div class="sv-col-3">
        <input
          id="user-search"
          class="card__bar-search-input"
          type="search"
          placeholder="Search usersâ€¦"
          autocomplete="off"
        />
      </div>
    </div>

    <div class="sv-card__body">
      <div class="sv-table__wrap">
        <table class="sv-table" aria-label="Users">
          <thead>
            <tr>
              <th>User</th>
              <th>Roles</th>
              <th>Plugins</th>
              <th>Status</th>
              <th>Activity</th>
              <th>Projects</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            {{#each users}}
            <tr
              data-id="{{id}}"
              data-name="{{displayName}}"
              data-email="{{email}}"
              data-roles="{{roleLabels}}"
              data-role-keys="{{roleKeys}}"
              data-first-name="{{firstName}}"
              data-last-name="{{lastName}}"
              data-status="{{status}}"
              data-plugins="{{pluginsEnabledNames}}"
              data-plugins-namespaces="{{pluginsEnabledNamespaces}}"
              data-plugins-count="{{pluginsEnabledCount}}"
              data-plugins-total="{{pluginsTotalCount}}"
            >
              <td>
                <div class="strong">{{displayName}}</div>
                <div class="subtle users-table__identity">
                  <span>{{email}}</span>
                  {{#if emailVerified}}
                  <span class="badge badge--soft badge--tone-success">Verified</span>
                  {{else}}
                  <span class="badge badge--soft">Unverified</span>
                  {{/if}}
                </div>
              </td>
              <td>
                {{#if hasRoles}}
                <div class="users-table__roles">
                  <span class="badge badge--soft badge--tone-neutral"> {{primaryRoleLabel}} </span>
                  {{#if extraRoleCount}}
                  <span class="badge badge--soft"> +{{extraRoleCount}} more </span>
                  {{/if}}
                </div>
                {{else}}
                <span class="subtle">None</span>
                {{/if}}
              </td>
              <td>
                <div class="users-table__plugins">
                  <div class="users-table__plugins-summary">
                    <span class="badge badge--soft badge--tone-neutral">
                      {{#if pluginsTotalCount}}
                      {{pluginsEnabledCount}} / {{pluginsTotalCount}}
                      {{else}}None{{/if}}
                    </span>
                  </div>
                  <div class="users-table__plugins-list">
                    {{#if pluginsEnabledCount}}
                    {{#each pluginsPreview}}
                    <span class="badge badge--soft badge--tone-neutral">{{this}}</span>
                    {{/each}}
                    {{/if}}
                    {{#if pluginsOverflow}}
                    <span class="badge badge--soft">+{{pluginsOverflow}} more</span>
                    {{/if}}
                    {{#unless pluginsEnabledCount}}
                    <span class="subtle">{{pluginsSummary}}</span>
                    {{/unless}}
                  </div>
                </div>
              </td>
              <td>
                <span class="badge badge--soft badge--tone-{{statusTone}}"> {{statusLabel}} </span>
              </td>
              <td>
                <div class="users-table__meta">
                  <div>
                    Created
                    <time datetime="{{createdAtISO}}" title="{{createdAtDisplay}}">
                      {{#if createdAtRelative}} {{createdAtRelative}} {{else}} {{createdAtDisplay}}
                      {{/if}}
                    </time>
                  </div>
                  {{#if lastSeenRelative}}
                  <div>
                    Last active
                    <time datetime="{{lastSeenISO}}" title="{{lastSeenDisplay}}">
                      {{lastSeenRelative}}
                    </time>
                  </div>
                  {{else if inviteSentRelative}}
                  <div>
                    Invite sent
                    <time datetime="{{inviteSentISO}}" title="{{inviteSentDisplay}}">
                      {{inviteSentRelative}}
                    </time>
                    {{#if inviteExpired}}
                    <span class="badge badge--soft badge--tone-warning">Expired</span>
                    {{/if}}
                  </div>
                  {{/if}}
                </div>
              </td>
              <td>
                <span class="subtle">{{projectsSummary}}</span>
              </td>
              <td>
                <div class="row-actions">
                  <button
                    class="button sv-icon-button"
                    aria-label="Edit user"
                    title="Edit user"
                    type="button"
                    data-action="edit-user"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      width="18"
                      height="18"
                      stroke-width="1.5"
                      stroke="currentColor"
                      aria-hidden="true"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                      />
                    </svg>
                  </button>
                  <button
                    class="button sv-icon-button"
                    type="button"
                    data-action="delete"
                    data-id="{{id}}"
                    aria-label="Delete user"
                    title="Delete user"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      width="18"
                      height="18"
                      stroke-width="1.5"
                      stroke="currentColor"
                      aria-hidden="true"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                      />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
            {{/each}}

            <tr class="empty-row" hidden>
              <td colspan="6" class="empty">No users found</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>
<script>
  (() => {
    const input = document.getElementById("user-search");
    const tbody = document.getElementById("users-tbody");
    if (!input || !tbody) return;

    const rows = Array.from(tbody.querySelectorAll("tr[data-id]"));
    const emptyRow = tbody.querySelector(".empty-row");

    const normalize = (s) =>
      (s || "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");

    const applyFilter = () => {
      const q = normalize(input.value.trim());
      let visible = 0;

      for (const tr of rows) {
        const haystack = normalize(
          [
            tr.dataset.name,
            tr.dataset.email,
            tr.dataset.roles,
            tr.dataset.status,
            tr.dataset.plugins,
          ].join(" ")
        );
        const match = !q || haystack.includes(q);
        tr.hidden = !match;
        if (match) visible++;
      }

      if (emptyRow) emptyRow.hidden = visible !== 0;
    };

    input.addEventListener("input", applyFilter);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        input.value = "";
        applyFilter();
        e.preventDefault();
      }
    });

    applyFilter();

    document.addEventListener("click", async (event) => {
      const deleteBtn = event.target.closest('button[data-action="delete"]');
      if (!deleteBtn) return;
      const userId = deleteBtn.dataset.id;
      if (!userId) return;
      const row = deleteBtn.closest("tr");
      const name = row?.dataset?.name || "this user";
      const confirmed = window.confirm(`Remove ${name}? This action cannot be undone.`);
      if (!confirmed) return;

      deleteBtn.setAttribute("disabled", "true");
      try {
        const resp = await fetch(`/api/plugins/users/${encodeURIComponent(userId)}`, {
          method: "DELETE",
          headers: { Accept: "application/json" },
        });
        if (!resp.ok && resp.status !== 204) {
          const data = await resp.json().catch(() => ({}));
          throw new Error(data?.error || `HTTP ${resp.status}`);
        }
        row?.remove();
        // Trigger filter recalculation to update empty state.
        applyFilter();
      } catch (error) {
        console.error("Failed to delete user:", error);
        window.alert(error?.message || "Failed to delete user. Please try again.");
      } finally {
        deleteBtn.removeAttribute("disabled");
      }
    });
  })();
</script>
