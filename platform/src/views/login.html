<!doctype html>
<html lang="{{head.lang.short}}">
  <head>
    {{> layout/head}}
    <link rel="stylesheet" href="/css/sv_pg_auth.css" />
  </head>
  <body class="sv-page sv-page__auth-login">
    <main class="auth__page sv-center">
      <section class="auth__page-header text-align-center" aria-label="Intro">
        <h1 class="auth__page-header-title">Sovereign</h1>
        <p class="auth__page-header-tagline">Reclaim your digital freedom</p>
      </section>

      <section class="auth__card-wrapper" aria-label="Sign in">
        <h2 class="auth__card-title">
          {{#if reset_mode}}Reset password{{else if forgot_mode}}Forgot your password{{else}}Sign
          in{{/if}}
        </h2>
        <div class="auth__card">
          {{#if success}}
          <div class="alert alert--success">{{success}}</div>
          {{/if}} {{#if error}}
          <div class="alert alert--error">{{error}}</div>
          {{/if}} {{!-- LOGIN FORM --}} {{#unless forgot_mode}} {{#unless reset_mode}}
          <form class="form" method="post" action="/login">
            <input type="hidden" name="return_to" value="{{return_to}}" />
            <div class="field">
              <label for="email">Email</label>
              <input
                id="email"
                name="email"
                type="email"
                class="input"
                placeholder="eg. john@example.com"
                value="{{values.email}}"
                required
              />
            </div>
            <div class="field">
              <label for="password">Password</label>
              <input
                id="password"
                name="password"
                type="password"
                class="input"
                placeholder="••••••••"
                required
              />
            </div>
            <div class="actions">
              <a class="sv-link" href="/login?forgot=1">Forgot your password?</a>
              <button class="button sv-button sv-button--primary" type="submit">Sign in</button>
            </div>
            {{#if passkeys_enabled}}
            <div class="actions" style="margin-top: 12px; flex-direction: column; gap: 6px">
              <button
                class="button sv-button sv-button--secondary"
                type="button"
                data-passkey-login
              >
                Sign in with passkey
              </button>
              <p
                data-passkey-status
                style="color: #475569; font-size: 13px; min-height: 18px; margin: 0"
              ></p>
            </div>
            {{/if}}
          </form>
          {{#if allow_signup}}
          <div class="divider"></div>
          <div class="actions">
            <span style="color: #64748b; font-size: 13px"
              >Don’t have an account? <a class="sv-link" href="/register">Create account</a></span
            >
          </div>
          {{/if}} {{#if guest_enabled}}
          <div class="divider"></div>
          <div class="actions">
            <a class="sv-link" href="/auth/guest">Continue as guest</a>
          </div>
          {{/if}} {{/unless}} {{/unless}} {{!-- FORGOT PASSWORD FORM --}} {{#if forgot_mode}}
          <form class="form" method="post" action="/auth/password/forgot">
            <div class="field">
              <label for="email">Email</label>
              <input
                id="email"
                name="email"
                type="email"
                class="input"
                placeholder="eg. john@example.com"
                value="{{values.email}}"
                required
              />
            </div>
            <div class="actions">
              <a class="sv-link" href="/login">Back to sign in</a>
              <button class="button sv-button sv-button--primary" type="submit">
                Send reset link
              </button>
            </div>
            {{#if dev_reset_url}}
            <div class="divider"></div>
            <div class="actions">
              <span style="color: #64748b; font-size: 12px">Dev:</span>
              <a class="sv-link" href="{{dev_reset_url}}">Open reset link</a>
            </div>
            {{/if}}
          </form>
          {{/if}} {{!-- RESET PASSWORD FORM --}} {{#if reset_mode}}
          <form class="form" method="post" action="/auth/password/reset">
            <input type="hidden" name="token" value="{{token}}" />
            <div class="field">
              <label for="password">New password</label>
              <input
                id="password"
                name="password"
                type="password"
                class="input"
                placeholder="At least 6 characters incl. a letter & number"
                required
              />
            </div>
            <div class="field">
              <label for="confirm_password">Confirm password</label>
              <input
                id="confirm_password"
                name="confirm_password"
                type="password"
                class="input"
                placeholder="Re-enter your password"
                required
              />
            </div>
            <div class="actions">
              <a class="sv-link" href="/login">Back to sign in</a>
              <button class="button sv-button sv-button--primary" type="submit">
                Update password
              </button>
            </div>
          </form>
          {{/if}}
        </div>
      </section>
    </main>
  </body>
  {{#if passkeys_enabled}}
  <script type="module" src="/js/passkeys.js?v={{head.cacheBuster}}" defer></script>
  <script type="module">
    const supportText = document.querySelector("[data-passkey-status]");
    const button = document.querySelector("[data-passkey-login]");
    const returnToInput = document.querySelector('input[name="return_to"]');
    const emailInput = document.querySelector("#email");

    const setStatus = (msg, isError = false) => {
      if (!supportText) return;
      supportText.textContent = msg || "";
      supportText.style.color = isError ? "#dc2626" : "#475569";
    };

    const disable = (state) => {
      if (button) button.disabled = state;
    };

    const passkeys = window.SVPasskeys;
    if (!passkeys || !passkeys.isSupported()) {
      if (button) button.style.display = "none";
      setStatus("Passkeys not supported in this browser.");
    } else if (button) {
      button.addEventListener("click", async () => {
        disable(true);
        setStatus("Waiting for your passkey…");
        try {
          const email = emailInput?.value?.trim() || "";
          const returnTo = returnToInput?.value || "/";
          const result = await passkeys.startLogin({ email, returnTo });
          if (result?.redirect) {
            window.location.href = result.redirect;
          } else {
            window.location.reload();
          }
        } catch (err) {
          setStatus(err?.message || "Passkey sign-in failed.", true);
          disable(false);
        }
      });
    }
  </script>
  {{/if}}
</html>
