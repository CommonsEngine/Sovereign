<!doctype html>
<html lang="{{head.lang.short}}">
  <head>
    {{> layout/head}}
    <link rel="stylesheet" href="/css/pages/settings.css" />
    <link rel="stylesheet" href="/css/components/sidebar.css" />
    <link rel="stylesheet" href="/css/components/userbar.css" />
    <link rel="stylesheet" href="/css/components/breadcrumb.css" />
  </head>
  <body class="page page--settings">
    {{> sidebar settings_active=true}} {{> userbar show_user_menu=true}}

    <main class="page__wrap">
      <h2 class="page__title">Settings</h2>

      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <ol class="breadcrumb__list">
          <li class="breadcrumb__item">
            <a class="breadcrumb__link" href="/">Home</a>
          </li>
          <li class="breadcrumb__item" aria-current="page">
            <span class="breadcrumb__current">Settings</span>
          </li>
        </ol>
      </nav>

      <section class="grid">
        <!-- App settings -->
        <article class="card" style="grid-column: 1 / -1">
          <div class="card__bar"><strong>App Settings</strong></div>
          <div class="card__body">
            <form id="app-form" class="form card__form">
              <div class="row">
                <div class="field">
                  <label class="label" for="appName">App Name</label>
                  <input
                    id="appName"
                    class="input"
                    type="text"
                    placeholder="Sovereign"
                    value="Sovereign"
                  />
                </div>
                <div class="field">
                  <label class="label" for="appTagline">Tagline</label>
                  <input
                    id="appTagline"
                    class="input"
                    type="text"
                    placeholder="Reclaim your digital freedom."
                    value="Reclaim your digital freedom."
                  />
                </div>
              </div>

              <div class="row row--single">
                <div class="field">
                  <label class="label" for="appDescription">Description</label>
                  <textarea
                    id="appDescription"
                    class="input"
                    rows="3"
                    placeholder="A Sovereign application"
                  >
A Sovereign application</textarea
                  >
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label class="label" for="baseUrl">Base URL</label>
                  <input
                    id="baseUrl"
                    class="input"
                    type="url"
                    placeholder="https://example.com"
                    value="https://example.com"
                  />
                </div>
                <div class="field">
                  <label class="label" for="appVersion">App Version</label>
                  <input
                    id="appVersion"
                    class="input"
                    type="text"
                    placeholder="0.1.0"
                    value="0.1.0"
                  />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label class="label" for="defaultUserRole"
                    >Default User Role</label
                  >
                  <input
                    id="defaultUserRole"
                    class="input"
                    type="text"
                    placeholder="guest"
                    value="guest"
                  />
                </div>
                <div class="field">
                  <label class="label" for="signupPolicy">Signup Policy</label>
                  <select id="signupPolicy" class="input">
                    <option value="invite" selected>Invite only</option>
                    <option value="open">Open registration</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label class="label" for="passwordMinLength"
                    >Password Min Length</label
                  >
                  <input
                    id="passwordMinLength"
                    class="input"
                    type="number"
                    min="4"
                    value="8"
                  />
                </div>
                <div class="field">
                  <label class="label" for="sessionTtlMs"
                    >Session TTL (ms)</label
                  >
                  <input
                    id="sessionTtlMs"
                    class="input"
                    type="number"
                    min="60000"
                    step="60000"
                    value="86400000"
                  />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label class="label" for="cookieName"
                    >Session Cookie Name</label
                  >
                  <input
                    id="cookieName"
                    class="input"
                    type="text"
                    placeholder="svg_session"
                    value="svg_session"
                  />
                </div>
                <div class="field">
                  <label class="label" for="dateFormat">Date Format</label>
                  <select id="dateFormat" class="input">
                    <option value="locale" selected>System locale</option>
                    <option value="iso">ISO 8601</option>
                    <option value="ymd">YYYY-MM-DD HH:mm</option>
                    <option value="mdy">MMM d, yyyy h:mm a</option>
                  </select>
                </div>
              </div>

              <div class="row row--single">
                <div class="field">
                  <label class="label">Access & Compliance</label>
                  <div
                    style="
                      display: flex;
                      gap: 18px;
                      align-items: center;
                      flex-wrap: wrap;
                    "
                  >
                    <label style="display: flex; gap: 8px; align-items: center">
                      <input id="allowGuest" type="checkbox" />
                      <span>Enable guest mode</span>
                    </label>
                    <label style="display: flex; gap: 8px; align-items: center">
                      <input id="guestBypass" type="checkbox" />
                      <span>Guest login bypass</span>
                    </label>
                    <label style="display: flex; gap: 8px; align-items: center">
                      <input id="requireTerms" type="checkbox" />
                      <span>Require terms acceptance</span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="actions">
                <span class="spacer"></span>
                <button id="reset-app" class="chip" type="button">Reset</button>
                <button id="save-app" class="chip chip--primary" type="submit">
                  Save changes
                </button>
              </div>
            </form>
          </div>
        </article>

        <!-- Localization -->
        <article class="card" style="grid-column: 1 / -1">
          <div class="card__bar"><strong>Localization</strong></div>
          <div class="card__body">
            <form id="loc-form" class="form card__form">
              <div class="row">
                <div class="field">
                  <label class="label" for="defaultLocale"
                    >Default Locale</label
                  >
                  <select id="defaultLocale" class="input" data-default="en-US">
                    <option value="en-US" selected>English (US)</option>
                    <option value="en-GB">English (UK)</option>
                    <option value="en-CA">English (Canada)</option>
                    <option value="fr-FR">French (France)</option>
                    <option value="de-DE">German (Germany)</option>
                    <option value="es-ES">Spanish (Spain)</option>
                    <option value="es-MX">Spanish (Mexico)</option>
                    <option value="pt-BR">Portuguese (Brazil)</option>
                    <option value="ja-JP">Japanese</option>
                  </select>
                </div>
                <div class="field">
                  <label class="label" for="defaultCurrency"
                    >Default Currency</label
                  >
                  <input
                    id="defaultCurrency"
                    class="input"
                    type="text"
                    placeholder="USD"
                    value="USD"
                    data-default="USD"
                  />
                </div>
              </div>

              <div class="row row--single">
                <div class="field">
                  <label class="label" for="supportedLocales"
                    >Supported Locales</label
                  >
                  <textarea
                    id="supportedLocales"
                    class="input"
                    rows="2"
                    placeholder="en-US,en-GB"
                    data-default="en-US,en-GB"
                  >
en-US,en-GB</textarea
                  >
                  <div class="help">Comma separated list of locale codes.</div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label class="label" for="timeZone">Time Zone</label>
                  <select id="timeZone" class="input" data-default="UTC">
                    <option value="UTC" selected>UTC</option>
                    <option value="Europe/London">Europe/London</option>
                    <option value="Europe/Berlin">Europe/Berlin</option>
                    <option value="Europe/Paris">Europe/Paris</option>
                    <option value="America/New_York">America/New_York</option>
                    <option value="America/Los_Angeles">
                      America/Los_Angeles
                    </option>
                    <option value="Asia/Colombo">Asia/Colombo</option>
                    <option value="Asia/Kolkata">Asia/Kolkata</option>
                    <option value="Asia/Tokyo">Asia/Tokyo</option>
                    <option value="Australia/Sydney">Australia/Sydney</option>
                  </select>
                  <div class="help">
                    Used for displaying dates/times across the app.
                  </div>
                </div>
              </div>

              <div class="actions">
                <span class="spacer"></span>
                <button id="reset-loc" class="chip" type="button">Reset</button>
                <button id="save-loc" class="chip chip--primary" type="submit">
                  Save changes
                </button>
              </div>
            </form>
          </div>
        </article>
      </section>
    </main>

    <script>
      async function sendSettings(entries, submitter, successMessage) {
        if (!Array.isArray(entries) || entries.length === 0) return;
        if (submitter) {
          submitter.dataset.prevText = submitter.textContent;
          submitter.textContent = "Saving...";
          submitter.disabled = true;
        }

        try {
          const res = await fetch("/api/settings", {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ settings: entries }),
          });

          let data = null;
          try {
            data = await res.json();
          } catch (err) {
            // Ignore JSON parsing errors; we'll show generic message below if needed.
          }

          if (!res.ok) {
            const errMsg =
              (data && data.error) ||
              `Failed to save settings (status ${res.status})`;
            throw new Error(errMsg);
          }

          alert(successMessage || "Settings saved.");
        } catch (err) {
          console.error("Failed to save settings", err);
          alert(err.message || "Failed to save settings.");
        } finally {
          if (submitter) {
            submitter.disabled = false;
            submitter.textContent =
              submitter.dataset.prevText || submitter.textContent;
            delete submitter.dataset.prevText;
          }
        }
      }

      document
        .getElementById("app-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.currentTarget;
          const submitter =
            e.submitter || form.querySelector('[type="submit"]');

          const appName = document.getElementById("appName").value.trim();
          const appTagline = document.getElementById("appTagline").value.trim();
          const appDescription = document
            .getElementById("appDescription")
            .value.trim();
          const baseUrl = document.getElementById("baseUrl").value.trim();
          const appVersion = document.getElementById("appVersion").value.trim();
          const defaultUserRole = document
            .getElementById("defaultUserRole")
            .value.trim();
          const signupPolicy =
            document.getElementById("signupPolicy").value || "invite";
          const passwordMinLengthRaw = Number.parseInt(
            document.getElementById("passwordMinLength").value,
            10,
          );
          const passwordMinLength = Number.isFinite(passwordMinLengthRaw)
            ? Math.max(1, passwordMinLengthRaw)
            : 8;
          const sessionTtlRaw = Number.parseInt(
            document.getElementById("sessionTtlMs").value,
            10,
          );
          const sessionTtlMs = Number.isFinite(sessionTtlRaw)
            ? Math.max(60000, sessionTtlRaw)
            : 24 * 60 * 60 * 1000;
          const cookieName = document.getElementById("cookieName").value.trim();
          const allowGuest = document.getElementById("allowGuest").checked;
          const guestBypass = document.getElementById("guestBypass").checked;
          const requireTerms = document.getElementById("requireTerms").checked;
          const dateFormat = document.getElementById("dateFormat").value;

          const entries = [
            { key: "env.app.name", value: appName || null },
            { key: "env.app.tagline", value: appTagline || null },
            { key: "env.app.description", value: appDescription || null },
            { key: "env.app.version", value: appVersion || null },
            { key: "env.app.url", value: baseUrl || null },
            { key: "default.user.role", value: defaultUserRole || null },
            { key: "signup.policy", value: signupPolicy },
            { key: "auth.password.min_length", value: passwordMinLength },
            { key: "auth.session.ttl_ms", value: sessionTtlMs },
            { key: "auth.cookie.name", value: cookieName || "svg_session" },
            {
              key: "feature.guest.login.enabled",
              value: allowGuest,
            },
            {
              key: "feature.guest.login.enabled.bypass",
              value: guestBypass,
            },
            {
              key: "feature.terms.require_acceptance",
              value: requireTerms,
            },
            { key: "ui.date.format", value: dateFormat },
          ];

          await sendSettings(entries, submitter, "App settings saved.");
        });

      document
        .getElementById("loc-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.currentTarget;
          const submitter =
            e.submitter || form.querySelector('[type="submit"]');
          const defaultLocale = document.getElementById("defaultLocale").value;
          const supportedLocalesRaw =
            document.getElementById("supportedLocales").value;
          const supportedLocales = supportedLocalesRaw
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
          const defaultCurrency = document
            .getElementById("defaultCurrency")
            .value.trim();
          const timeZone = document.getElementById("timeZone").value;

          const entries = [
            { key: "env.locale.default", value: defaultLocale },
            {
              key: "env.locale.supported",
              value:
                supportedLocales.length > 0
                  ? supportedLocales
                  : [defaultLocale],
            },
            { key: "env.currency.default", value: defaultCurrency || "USD" },
            { key: "env.timezone.default", value: timeZone },
          ];

          await sendSettings(entries, submitter, "Localization saved.");
        });

      // Reset buttons
      document.getElementById("reset-app").addEventListener("click", () => {
        window.location.reload();
      });
      document.getElementById("reset-loc").addEventListener("click", () => {
        const localeSel = document.getElementById("defaultLocale");
        localeSel.value =
          localeSel.dataset.default ||
          localeSel.querySelector("option[selected]")?.value ||
          "en-US";
        const supportedInput = document.getElementById("supportedLocales");
        supportedInput.value = supportedInput.dataset.default || "en-US,en-GB";
        const currencyInput = document.getElementById("defaultCurrency");
        currencyInput.value = currencyInput.dataset.default || "USD";
        const sel = document.getElementById("timeZone");
        sel.value =
          sel.dataset.default ||
          sel.querySelector("option[selected]")?.value ||
          "UTC";
      });
    </script>
  </body>
</html>
