<!doctype html>
<html lang="{{head.lang.short}}">
  <head>
    {{> layout/head}}
    <link rel="stylesheet" href="/css/components/sidebar.css" />
    <link rel="stylesheet" href="/css/components/userbar.css" />
    <link rel="stylesheet" href="/css/components/breadcrumb.css" />

    <style>
      /* Ensure checkbox + label text stay on one line */
      .checkbox-inline {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        white-space: nowrap; /* prevent label text wrapping to next line */
      }
      .checkbox-inline input[type="checkbox"] {
        margin: 0;
        flex: 0 0 auto;
        width: auto;
        height: auto;
      }
      /* allow the row to wrap if viewport is narrow, but keep each label inline */
      .row.gap-xs {
        gap: 12px;
        flex-wrap: wrap;
      }
      .actions {
        gap: var(--space-xs);
      }
      @media (max-width: 560px) {
        .checkbox-inline {
          white-space: normal;
          align-items: flex-start;
        }
        .checkbox-inline span {
          line-height: 1.4;
        }
        .actions {
          flex-direction: column;
          align-items: stretch;
        }
        .actions .button {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body class="page page--with-sidebar page--settings">
    {{> sidebar settings_active=true}} {{> userbar show_user_menu=true}}

    <main class="page__wrap">
      <h2 class="page__title">Settings</h2>

      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <ol class="breadcrumb__list">
          <li class="breadcrumb__item">
            <a class="breadcrumb__link" href="/">Home</a>
          </li>
          <li class="breadcrumb__item" aria-current="page">
            <span class="breadcrumb__current">Settings</span>
          </li>
        </ol>
      </nav>

      <section class="grid">
        <!-- App settings -->
        <article class="card" style="grid-column: 1 / -1">
          <div class="card__bar"><strong>App Settings</strong></div>
          <div class="card__body">
            <form id="app-form" class="form card__form">
              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="appName">App Name</label>
                  <input
                    id="appName"
                    class="input"
                    type="text"
                    placeholder="Sovereign"
                    value="Sovereign"
                  />
                </div>
                <div class="field">
                  <label class="label" for="appTagline">Tagline</label>
                  <input
                    id="appTagline"
                    class="input"
                    type="text"
                    placeholder="Reclaim your digital freedom."
                    value="Reclaim your digital freedom."
                  />
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="appDescription">Description</label>
                  <textarea
                    id="appDescription"
                    class="input"
                    rows="3"
                    placeholder="A Sovereign application"
                  >
A Sovereign application</textarea
                  >
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="baseUrl">Base URL</label>
                  <input
                    id="baseUrl"
                    class="input"
                    type="url"
                    placeholder="https://example.com"
                    value="https://example.com"
                  />
                </div>
                <div class="field">
                  <label class="label" for="appVersion">App Version</label>
                  <input
                    id="appVersion"
                    class="input"
                    type="text"
                    placeholder="0.1.0"
                    value="0.1.0"
                  />
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="defaultUserRole"
                    >Default User Role</label
                  >
                  <input
                    id="defaultUserRole"
                    class="input"
                    type="text"
                    placeholder="guest"
                    value="guest"
                  />
                </div>
                <div class="field">
                  <label class="label" for="signupPolicy">Signup Policy</label>
                  <select id="signupPolicy" class="input">
                    <option value="invite" selected>Invite only</option>
                    <option value="open">Open registration</option>
                  </select>
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="passwordMinLength"
                    >Password Min Length</label
                  >
                  <input
                    id="passwordMinLength"
                    class="input"
                    type="number"
                    min="4"
                    value="8"
                  />
                </div>
                <div class="field">
                  <label class="label" for="sessionTtlMs"
                    >Session TTL (ms)</label
                  >
                  <input
                    id="sessionTtlMs"
                    class="input"
                    type="number"
                    min="60000"
                    step="60000"
                    value="86400000"
                  />
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="cookieName"
                    >Session Cookie Name</label
                  >
                  <input
                    id="cookieName"
                    class="input"
                    type="text"
                    placeholder="svg_session"
                    value="svg_session"
                  />
                </div>
                <div class="field">
                  <label class="label" for="dateFormat">Date Format</label>
                  <select id="dateFormat" class="input">
                    <option value="locale" selected>System locale</option>
                    <option value="iso">ISO 8601</option>
                    <option value="ymd">YYYY-MM-DD HH:mm</option>
                    <option value="mdy">MMM d, yyyy h:mm a</option>
                  </select>
                </div>
              </div>

              <div class="col gap-2xs">
                <label class="label">Access & Compliance</label>
                <div class="row gap-xs" style="align-items: center">
                  <label class="checkbox-inline">
                    <input id="allowGuest" type="checkbox" />
                    <span>Enable guest mode</span>
                  </label>
                  <label class="checkbox-inline">
                    <input id="guestBypass" type="checkbox" />
                    <span>Guest login bypass</span>
                  </label>
                  <label class="checkbox-inline">
                    <input id="requireTerms" type="checkbox" />
                    <span>Require terms acceptance</span>
                  </label>
                </div>
              </div>

              <div class="row row-reverse gap-2xs actions">
                <button
                  id="save-app"
                  class="button button--primary chip chip--primary"
                  type="submit"
                >
                  Save changes
                </button>
                <button id="reset-app" class="button chip" type="button">
                  Reset
                </button>
              </div>
            </form>
          </div>
        </article>

        <!-- Email -->
        <article class="card" style="grid-column: 1 / -1">
          <div class="card__bar"><strong>Email Settings</strong></div>
          <div class="card__body">
            <form id="email-form" class="form card__form">
              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="emailFromName">From Name</label>
                  <input
                    id="emailFromName"
                    class="input"
                    type="text"
                    placeholder="Sovereign"
                  />
                </div>
                <div class="field">
                  <label class="label" for="emailFromAddress"
                    >From Address</label
                  >
                  <input
                    id="emailFromAddress"
                    class="input"
                    type="email"
                    placeholder="no-reply@example.com"
                  />
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="emailReplyTo">Reply-To</label>
                  <input
                    id="emailReplyTo"
                    class="input"
                    type="email"
                    placeholder="support@example.com"
                  />
                  <div class="form__helptext">
                    Optional: leave blank to use the From address.
                  </div>
                </div>
                <div class="field">
                  <label class="label" style="display: block">Delivery</label>
                  <label class="checkbox-inline">
                    <input id="emailBypass" type="checkbox" />
                    <span>Bypass outbound email (log only)</span>
                  </label>
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="smtpUrl">SMTP URL</label>
                  <input
                    id="smtpUrl"
                    class="input"
                    type="text"
                    placeholder="smtps://user:pass@mail.example.com:465"
                  />
                  <div class="form__helptext">
                    Optional: overrides host/port/user fields when provided.
                  </div>
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="smtpHost">SMTP Host</label>
                  <input
                    id="smtpHost"
                    class="input"
                    type="text"
                    placeholder="mail.example.com"
                  />
                </div>
                <div class="field">
                  <label class="label" for="smtpPort">SMTP Port</label>
                  <input
                    id="smtpPort"
                    class="input"
                    type="number"
                    min="1"
                    step="1"
                    placeholder="587"
                  />
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" style="display: block">Security</label>
                  <div class="row gap-xs" style="align-items: center">
                    <label class="checkbox-inline">
                      <input id="smtpSecure" type="checkbox" />
                      <span>Use secure connection (TLS/SSL)</span>
                    </label>
                    <label class="checkbox-inline">
                      <input id="smtpIgnoreTls" type="checkbox" />
                      <span>Ignore TLS certificate validation</span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="smtpUser">SMTP Username</label>
                  <input
                    id="smtpUser"
                    class="input"
                    type="text"
                    placeholder="smtp-user"
                  />
                </div>
                <div class="field">
                  <label class="label" for="smtpPassword">SMTP Password</label>
                  <input
                    id="smtpPassword"
                    class="input"
                    type="password"
                    autocomplete="new-password"
                    placeholder="••••••••"
                  />
                </div>
              </div>

              <div class="row gap-2xs row-reverse actions">
                <button
                  class="button button--primary chip chip--primary"
                  type="submit"
                >
                  Save changes
                </button>
                <button id="reset-email" class="button chip" type="button">
                  Reset
                </button>
              </div>
            </form>
          </div>
        </article>

        <!-- Localization -->
        <article class="card" style="grid-column: 1 / -1">
          <div class="card__bar"><strong>Localization</strong></div>
          <div class="card__body">
            <form id="loc-form" class="form card__form">
              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="defaultLocale"
                    >Default Locale</label
                  >
                  <select id="defaultLocale" class="input" data-default="en-US">
                    <option value="en-US" selected>English (US)</option>
                    <option value="en-GB">English (UK)</option>
                    <!-- <option value="en-CA">English (Canada)</option>
                    <option value="fr-FR">French (France)</option>
                    <option value="de-DE">German (Germany)</option>
                    <option value="es-ES">Spanish (Spain)</option>
                    <option value="es-MX">Spanish (Mexico)</option>
                    <option value="pt-BR">Portuguese (Brazil)</option>
                    <option value="ja-JP">Japanese</option> -->
                  </select>
                </div>
                <div class="field">
                  <label class="label" for="defaultCurrency"
                    >Default Currency</label
                  >
                  <input
                    id="defaultCurrency"
                    class="input"
                    type="text"
                    placeholder="USD"
                    value="USD"
                    data-default="USD"
                    readonly
                  />
                </div>
              </div>

              <div class="col gap-xs">
                <div class="field">
                  <label class="label" for="supportedLocales"
                    >Supported Locales</label
                  >
                  <textarea
                    id="supportedLocales"
                    class="input"
                    rows="2"
                    placeholder="en-US,en-GB"
                    data-default="en-US,en-GB"
                    readonly
                  >
en-US</textarea
                  >
                  <div class="form__helptext">
                    Comma separated list of locale codes.
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="field">
                  <label class="label" for="timeZone">Time Zone</label>
                  <select id="timeZone" class="input" data-default="UTC">
                    <option value="UTC" selected>UTC</option>
                    <!-- <option value="Europe/London">Europe/London</option>
                    <option value="Europe/Berlin">Europe/Berlin</option>
                    <option value="Europe/Paris">Europe/Paris</option>
                    <option value="America/New_York">America/New_York</option>
                    <option value="America/Los_Angeles">
                      America/Los_Angeles
                    </option>
                    <option value="Asia/Colombo">Asia/Colombo</option>
                    <option value="Asia/Kolkata">Asia/Kolkata</option>
                    <option value="Asia/Tokyo">Asia/Tokyo</option>
                    <option value="Australia/Sydney">Australia/Sydney</option> -->
                  </select>
                  <div class="form__helptext">
                    Used for displaying dates/times across the app.
                  </div>
                </div>
              </div>

              <div class="row gap-2xs row-reverse">
                <button
                  id="save-loc"
                  class="button button--primary chip chip--primary"
                  type="submit"
                >
                  Save changes
                </button>
                <button id="reset-loc" class="button chip" type="button">
                  Reset
                </button>
              </div>
            </form>
          </div>
        </article>
      </section>
    </main>

    <script>
      const SETTINGS_FIELD_MAP = {
        "env.app.name": { id: "appName" },
        "env.app.tagline": { id: "appTagline" },
        "env.app.description": { id: "appDescription" },
        "env.app.version": { id: "appVersion" },
        "env.app.url": { id: "baseUrl" },
        "default.user.role": { id: "defaultUserRole" },
        "signup.policy": { id: "signupPolicy" },
        "auth.password.min_length": { id: "passwordMinLength" },
        "auth.session.ttl_ms": { id: "sessionTtlMs" },
        "auth.cookie.name": { id: "cookieName" },
        "feature.guest.login.enabled": { id: "allowGuest" },
        "feature.guest.login.enabled.bypass": { id: "guestBypass" },
        "feature.terms.require_acceptance": { id: "requireTerms" },
        "ui.date.format": { id: "dateFormat" },
        "feature.email.delivery.bypass": { id: "emailBypass" },
        "email.from.name": { id: "emailFromName" },
        "email.from.address": { id: "emailFromAddress" },
        "email.reply_to": { id: "emailReplyTo" },
        "email.smtp.url": { id: "smtpUrl" },
        "email.smtp.host": { id: "smtpHost" },
        "email.smtp.port": { id: "smtpPort" },
        "email.smtp.secure": { id: "smtpSecure" },
        "email.smtp.ignore_tls": { id: "smtpIgnoreTls" },
        "email.smtp.user": { id: "smtpUser" },
        "email.smtp.password": {
          id: "smtpPassword",
          toInput: (value) =>
            value === null || value === undefined ? "" : value,
        },
        "env.locale.default": { id: "defaultLocale" },
        "env.locale.supported": {
          id: "supportedLocales",
          toInput: (value) =>
            Array.isArray(value) ? value.join(",") : String(value ?? ""),
        },
        "env.currency.default": {
          id: "defaultCurrency",
          toInput: (value) =>
            typeof value === "string"
              ? value.toUpperCase()
              : String(value ?? ""),
        },
        "env.timezone.default": { id: "timeZone" },
      };

      const LOCALE_PATTERN = /^[a-z]{2,3}(?:[-_][a-z0-9]+)*$/i;
      const EMAIL_PATTERN = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      function normalizeLocaleInput(value) {
        if (value === null || value === undefined) return "";
        const raw = String(value).trim();
        if (!raw) return "";
        const normalized = raw.replace(/_/g, "-");
        if (!LOCALE_PATTERN.test(normalized)) return null;
        const segments = normalized.split("-");
        const base = segments.shift().toLowerCase();
        const formatted = segments.map((segment) => {
          if (!segment) return segment;
          if (segment.length <= 2) return segment.toUpperCase();
          return segment[0].toUpperCase() + segment.slice(1);
        });
        return [base, ...formatted].filter(Boolean).join("-");
      }

      function toBoolean(value) {
        if (typeof value === "boolean") return value;
        if (typeof value === "number") return value !== 0;
        if (typeof value === "string") {
          const normalized = value.trim().toLowerCase();
          return ["true", "1", "yes", "on"].includes(normalized);
        }
        return Boolean(value);
      }

      function setFieldValue(id, rawValue, config = {}) {
        const field = document.getElementById(id);
        if (!field) return;

        const value =
          typeof config.toInput === "function"
            ? config.toInput(rawValue)
            : rawValue;

        if (field.type === "checkbox") {
          field.checked = toBoolean(value);
          return;
        }

        if (field.tagName === "SELECT") {
          const selectValue = Array.isArray(value)
            ? String(value[0] ?? "")
            : (value ?? "");
          if (typeof selectValue === "string" && selectValue) {
            const hasOption = Array.from(field.options).some(
              (opt) => opt.value === selectValue,
            );
            if (!hasOption) {
              const opt = document.createElement("option");
              opt.value = selectValue;
              opt.textContent = selectValue;
              field.appendChild(opt);
            }
            field.value = selectValue;
          }
          return;
        }

        if (field.type === "number") {
          if (value === null || value === undefined || value === "") {
            field.value = "";
            return;
          }
          const num = Number(value);
          if (!Number.isNaN(num)) {
            field.value = num;
          }
          return;
        }

        if (field.tagName === "TEXTAREA") {
          field.value = value ?? "";
          return;
        }

        field.value = value ?? "";
      }

      async function loadSettings() {
        try {
          const res = await fetch("/api/settings");
          if (!res.ok) {
            throw new Error(`Failed to load settings (status ${res.status})`);
          }
          const data = await res.json();
          const settings = data?.settings || {};

          for (const [key, config] of Object.entries(SETTINGS_FIELD_MAP)) {
            if (!(key in settings)) continue;
            setFieldValue(config.id, settings[key], config);
          }
        } catch (err) {
          console.error("Failed to load settings", err);
        }
      }

      function markFieldError(field, hasError) {
        if (!field) return;
        field.classList.toggle("input--error", hasError);
        const messageEl =
          field.parentElement?.querySelector(".help.help--error");
        if (messageEl) {
          messageEl.style.display = hasError ? "block" : "none";
        }
      }

      function validateAppForm() {
        const errors = [];

        const nameField = document.getElementById("appName");
        const nameValue = nameField.value.trim();
        markFieldError(nameField, false);
        if (!nameValue) {
          errors.push("App name is required.");
          markFieldError(nameField, true);
        } else {
          nameField.value = nameValue;
        }

        const urlField = document.getElementById("baseUrl");
        const urlValue = urlField.value.trim();
        markFieldError(urlField, false);
        if (urlValue && !/^https?:\/\/[^ ]+$/i.test(urlValue)) {
          errors.push("Base URL must be a valid http(s) URL.");
          markFieldError(urlField, true);
        } else {
          urlField.value = urlValue;
        }

        const passwordField = document.getElementById("passwordMinLength");
        const passValue = Number(passwordField.value);
        markFieldError(passwordField, false);
        if (!Number.isFinite(passValue) || passValue < 4) {
          errors.push("Password minimum length must be at least 4.");
          markFieldError(passwordField, true);
        } else {
          passwordField.value = String(Math.floor(passValue));
        }

        const ttlField = document.getElementById("sessionTtlMs");
        const ttlValue = Number(ttlField.value);
        markFieldError(ttlField, false);
        if (!Number.isFinite(ttlValue) || ttlValue < 60000) {
          errors.push("Session TTL must be at least 60000 ms (1 minute).");
          markFieldError(ttlField, true);
        } else {
          ttlField.value = String(Math.floor(ttlValue));
        }

        const cookieField = document.getElementById("cookieName");
        const cookieValue = cookieField.value.trim();
        markFieldError(cookieField, false);
        if (!cookieValue) {
          errors.push("Session cookie name is required.");
          markFieldError(cookieField, true);
        } else {
          cookieField.value = cookieValue;
        }

        return errors;
      }

      function validateLocalizationForm() {
        const errors = [];

        const currencyField = document.getElementById("defaultCurrency");
        const currencyValue = currencyField.value.trim();
        markFieldError(currencyField, false);
        if (!currencyValue || currencyValue.length !== 3) {
          errors.push("Default currency must be a 3-letter ISO code.");
          markFieldError(currencyField, true);
        } else {
          currencyField.value = currencyValue.toUpperCase();
        }

        const defaultLocaleField = document.getElementById("defaultLocale");
        markFieldError(defaultLocaleField, false);
        const normalizedDefaultLocale = normalizeLocaleInput(
          defaultLocaleField.value,
        );
        if (!normalizedDefaultLocale) {
          errors.push(
            "Default locale must be a valid locale code (e.g., en-US).",
          );
          markFieldError(defaultLocaleField, true);
        } else {
          defaultLocaleField.value = normalizedDefaultLocale;
        }

        const supportedField = document.getElementById("supportedLocales");
        markFieldError(supportedField, false);
        const rawLocales = supportedField.value
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);

        const normalizedLocales = [];
        const invalidLocales = [];

        for (const locale of rawLocales) {
          const normalized = normalizeLocaleInput(locale);
          if (!normalized) {
            invalidLocales.push(locale);
          } else {
            normalizedLocales.push(normalized);
          }
        }

        if (invalidLocales.length > 0) {
          errors.push(`Invalid locale codes: ${invalidLocales.join(", ")}`);
          markFieldError(supportedField, true);
        } else if (normalizedLocales.length > 0) {
          supportedField.value = normalizedLocales.join(",");
        }

        return errors;
      }

      function validateEmailForm() {
        const errors = [];

        const fromAddressField = document.getElementById("emailFromAddress");
        const fromAddress = fromAddressField.value.trim();
        markFieldError(fromAddressField, false);
        if (fromAddress && !EMAIL_PATTERN.test(fromAddress)) {
          errors.push("From address must be a valid email address.");
          markFieldError(fromAddressField, true);
        } else {
          fromAddressField.value = fromAddress;
        }

        const replyToField = document.getElementById("emailReplyTo");
        const replyTo = replyToField.value.trim();
        markFieldError(replyToField, false);
        if (replyTo && !EMAIL_PATTERN.test(replyTo)) {
          errors.push("Reply-To address must be a valid email address.");
          markFieldError(replyToField, true);
        } else {
          replyToField.value = replyTo;
        }

        const smtpUrlField = document.getElementById("smtpUrl");
        const smtpUrl = smtpUrlField.value.trim();
        markFieldError(smtpUrlField, false);
        if (smtpUrl && !/^smtps?:\/\//i.test(smtpUrl)) {
          errors.push("SMTP URL must start with smtp:// or smtps://.");
          markFieldError(smtpUrlField, true);
        } else {
          smtpUrlField.value = smtpUrl;
        }

        const smtpPortField = document.getElementById("smtpPort");
        const smtpPortRaw = smtpPortField.value.trim();
        markFieldError(smtpPortField, false);
        if (smtpPortRaw) {
          const smtpPort = Number.parseInt(smtpPortRaw, 10);
          if (!Number.isFinite(smtpPort) || smtpPort < 1) {
            errors.push("SMTP port must be a positive integer.");
            markFieldError(smtpPortField, true);
          } else {
            smtpPortField.value = String(smtpPort);
          }
        } else {
          smtpPortField.value = "";
        }

        return errors;
      }

      async function sendSettings(entries, submitter, successMessage) {
        if (!Array.isArray(entries) || entries.length === 0) return;
        if (submitter) {
          submitter.dataset.prevText = submitter.textContent;
          submitter.textContent = "Saving...";
          submitter.disabled = true;
        }

        try {
          const res = await fetch("/api/settings", {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ settings: entries }),
          });

          let data = null;
          try {
            data = await res.json();
          } catch (err) {
            // Ignore JSON parsing errors; we'll show generic message below if needed.
          }

          if (!res.ok) {
            const errMsg =
              (data && data.error) ||
              `Failed to save settings (status ${res.status})`;
            const details =
              Array.isArray(data?.details) && data.details.length
                ? `\n${data.details.join("\n")}`
                : "";
            throw new Error(`${errMsg}${details}`);
          }

          alert(successMessage || "Settings saved.");
        } catch (err) {
          console.error("Failed to save settings", err);
          alert(err.message || "Failed to save settings.");
        } finally {
          if (submitter) {
            submitter.disabled = false;
            submitter.textContent =
              submitter.dataset.prevText || submitter.textContent;
            delete submitter.dataset.prevText;
          }
        }
      }

      document
        .getElementById("email-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.currentTarget;
          const submitter =
            e.submitter || form.querySelector('[type="submit"]');

          const errors = validateEmailForm();
          if (errors.length > 0) {
            alert(errors.join("\n"));
            return;
          }

          const fromName = document
            .getElementById("emailFromName")
            .value.trim();
          const fromAddress = document
            .getElementById("emailFromAddress")
            .value.trim();
          const replyTo = document.getElementById("emailReplyTo").value.trim();
          const bypass = document.getElementById("emailBypass").checked;
          const smtpUrl = document.getElementById("smtpUrl").value.trim();
          const smtpHost = document.getElementById("smtpHost").value.trim();
          const smtpPortRaw = document.getElementById("smtpPort").value.trim();
          const smtpPort = smtpPortRaw
            ? Number.parseInt(smtpPortRaw, 10)
            : null;
          const smtpSecure = document.getElementById("smtpSecure").checked;
          const smtpIgnoreTls =
            document.getElementById("smtpIgnoreTls").checked;
          const smtpUser = document.getElementById("smtpUser").value.trim();
          const smtpPassword = document.getElementById("smtpPassword").value;

          const entries = [
            { key: "email.from.name", value: fromName || null },
            { key: "email.from.address", value: fromAddress || null },
            { key: "email.reply_to", value: replyTo || null },
            { key: "feature.email.delivery.bypass", value: bypass },
            { key: "email.smtp.url", value: smtpUrl || null },
            { key: "email.smtp.host", value: smtpHost || null },
            {
              key: "email.smtp.port",
              value:
                smtpPort !== null && Number.isFinite(smtpPort)
                  ? smtpPort
                  : null,
            },
            { key: "email.smtp.secure", value: smtpSecure },
            { key: "email.smtp.ignore_tls", value: smtpIgnoreTls },
            { key: "email.smtp.user", value: smtpUser || null },
            {
              key: "email.smtp.password",
              value:
                smtpPassword && smtpPassword.length > 0 ? smtpPassword : null,
            },
          ];

          await sendSettings(entries, submitter, "Email settings saved.");
        });

      document
        .getElementById("app-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.currentTarget;
          const submitter =
            e.submitter || form.querySelector('[type="submit"]');

          const errors = validateAppForm();
          if (errors.length > 0) {
            alert(errors.join("\n"));
            return;
          }

          const appName = document.getElementById("appName").value.trim();
          const appTagline = document.getElementById("appTagline").value.trim();
          const appDescription = document
            .getElementById("appDescription")
            .value.trim();
          const baseUrl = document.getElementById("baseUrl").value.trim();
          const appVersion = document.getElementById("appVersion").value.trim();
          const defaultUserRole = document
            .getElementById("defaultUserRole")
            .value.trim();
          const signupPolicy =
            document.getElementById("signupPolicy").value || "invite";
          const passwordMinLengthRaw = Number.parseInt(
            document.getElementById("passwordMinLength").value,
            10,
          );
          const passwordMinLength = Number.isFinite(passwordMinLengthRaw)
            ? Math.max(4, passwordMinLengthRaw)
            : 8;
          const sessionTtlRaw = Number.parseInt(
            document.getElementById("sessionTtlMs").value,
            10,
          );
          const sessionTtlMs = Number.isFinite(sessionTtlRaw)
            ? Math.max(60000, sessionTtlRaw)
            : 24 * 60 * 60 * 1000;
          const cookieName = document.getElementById("cookieName").value.trim();
          const allowGuest = document.getElementById("allowGuest").checked;
          const guestBypass = document.getElementById("guestBypass").checked;
          const requireTerms = document.getElementById("requireTerms").checked;
          const dateFormat = document.getElementById("dateFormat").value;

          const entries = [
            { key: "env.app.name", value: appName },
            { key: "env.app.tagline", value: appTagline || null },
            { key: "env.app.description", value: appDescription || null },
            { key: "env.app.version", value: appVersion || null },
            { key: "env.app.url", value: baseUrl || null },
            { key: "default.user.role", value: defaultUserRole || null },
            { key: "signup.policy", value: signupPolicy },
            { key: "auth.password.min_length", value: passwordMinLength },
            { key: "auth.session.ttl_ms", value: sessionTtlMs },
            { key: "auth.cookie.name", value: cookieName || "svg_session" },
            {
              key: "feature.guest.login.enabled",
              value: allowGuest,
            },
            {
              key: "feature.guest.login.enabled.bypass",
              value: guestBypass,
            },
            {
              key: "feature.terms.require_acceptance",
              value: requireTerms,
            },
            { key: "ui.date.format", value: dateFormat },
          ];

          await sendSettings(entries, submitter, "App settings saved.");
        });

      document
        .getElementById("loc-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.currentTarget;
          const submitter =
            e.submitter || form.querySelector('[type="submit"]');
          const errors = validateLocalizationForm();
          if (errors.length > 0) {
            alert(errors.join("\n"));
            return;
          }
          const defaultLocale = document.getElementById("defaultLocale").value;
          const supportedLocalesRaw =
            document.getElementById("supportedLocales").value;
          const supportedLocales = supportedLocalesRaw
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean)
            .map((locale) => normalizeLocaleInput(locale))
            .filter(Boolean);
          const defaultCurrency = document
            .getElementById("defaultCurrency")
            .value.trim()
            .toUpperCase();
          const timeZone = document.getElementById("timeZone").value;

          const entries = [
            { key: "env.locale.default", value: defaultLocale },
            {
              key: "env.locale.supported",
              value:
                supportedLocales.length > 0
                  ? supportedLocales
                  : [defaultLocale],
            },
            { key: "env.currency.default", value: defaultCurrency || "USD" },
            { key: "env.timezone.default", value: timeZone },
          ];

          await sendSettings(entries, submitter, "Localization saved.");
        });

      loadSettings();

      // Reset buttons
      document.getElementById("reset-email").addEventListener("click", () => {
        window.location.reload();
      });
      document.getElementById("reset-app").addEventListener("click", () => {
        window.location.reload();
      });
      document.getElementById("reset-loc").addEventListener("click", () => {
        const localeSel = document.getElementById("defaultLocale");
        localeSel.value =
          localeSel.dataset.default ||
          localeSel.querySelector("option[selected]")?.value ||
          "en-US";
        const supportedInput = document.getElementById("supportedLocales");
        supportedInput.value = supportedInput.dataset.default || "en-US,en-GB";
        const currencyInput = document.getElementById("defaultCurrency");
        currencyInput.value = currencyInput.dataset.default || "USD";
        const sel = document.getElementById("timeZone");
        sel.value =
          sel.dataset.default ||
          sel.querySelector("option[selected]")?.value ||
          "UTC";
      });
    </script>
  </body>
</html>
