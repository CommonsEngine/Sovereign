<!doctype html>
<html lang="{{head.lang.short}}">
  <head>
    {{> layout/head}}
    <link rel="stylesheet" href="/css/components/breadcrumb.css" />
    <link rel="stylesheet" href="/css/components/sidebar.css" />
    <link rel="stylesheet" href="/css/components/userbar.css" />
    <link rel="stylesheet" href="/css/components/modal.css" />
    <link rel="stylesheet" href="/css/components/card.css" />

    <style>
      .users-table__identity {
        display: inline-flex;
        flex-wrap: wrap;
        gap: var(--space-2xs);
        align-items: center;
      }
      .users-card__filters .badge {
        font-size: var(--font-size-xs);
      }
      .users-table__identity {
        display: inline-flex;
        flex-wrap: wrap;
        gap: var(--space-2xs);
        align-items: center;
      }
      .users-table__roles {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }
      .users-table__roles .badge {
        font-size: var(--font-size-xs);
        display: inline-flex;
        align-items: center;
        gap: var(--space-2xs);
        padding: 4px 10px;
      }
      .users-table__meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
        color: var(--color-text-secondary);
        font-size: var(--font-size-s);
      }
      .users-table__meta time {
        color: var(--color-text-primary);
        font-weight: var(--font-weight-medium);
        margin-left: var(--space-2xs);
      }
      .col-actions {
        text-align: right;
      }
      table td:last-child .row-actions {
        justify-content: flex-end;
      }
      .badge--soft {
        background: var(--color-bg-muted);
        border: 1px solid transparent;
        color: var(--color-text-secondary);
      }
      .badge--tone-success {
        background: color-mix(in oklab, var(--color-success) 18%, white 82%);
        border-color: color-mix(in oklab, var(--color-success) 30%, white 70%);
        color: color-mix(in oklab, var(--color-success) 70%, black 20%);
      }
      .badge--tone-warning {
        background: color-mix(in oklab, var(--color-warning) 25%, white 75%);
        border-color: color-mix(in oklab, var(--color-warning) 35%, white 65%);
        color: color-mix(in oklab, var(--color-warning) 65%, black 25%);
      }
      .badge--tone-danger {
        background: color-mix(in oklab, var(--color-danger) 18%, white 82%);
        border-color: color-mix(in oklab, var(--color-danger) 30%, white 70%);
        color: color-mix(in oklab, var(--color-danger) 70%, black 20%);
      }
      .badge--tone-neutral {
        background: var(--color-bg-muted);
        border-color: var(--color-border-primary);
        color: var(--color-text-secondary);
      }

      @media (max-width: 720px) {
        .page--users .users-page__header {
          flex-direction: column;
          align-items: stretch;
          gap: var(--space-m);
        }
        .col-actions,
        table td:last-child .row-actions {
          text-align: left;
          justify-content: flex-start;
        }
      }
    </style>
  </head>
  <body class="page page--users">
    {{> sidebar users_active=true}} {{> userbar show_user_menu=true}}

    <main class="page__wrap">
      <header class="page__header flex items-center justify-space-between">
        <div class="page__heading">
          <h2 class="page__title">Users</h2>
          <p class="page__subtitle">
            Manage access, invitations, and roles across your workspace.
          </p>
        </div>
        <button
          class="chip chip--primary button button--primary"
          type="button"
          data-modal-open="create-user"
        >
          Invite user
        </button>
      </header>

      <nav class="breadcrumb" aria-label="Breadcrumb">
        <ol class="breadcrumb__list">
          <li class="breadcrumb__item">
            <a class="breadcrumb__link" href="/">Home</a>
          </li>
          <li class="breadcrumb__item" aria-current="page">
            <span class="breadcrumb__current">Users</span>
          </li>
        </ol>
      </nav>

      {{#if stats}}
      <section class="card__row" aria-label="User overview">
        {{#each stats}}
        <article class="card__row--card">
          <span class="card__row--label">{{label}}</span>
          <span class="card__row--value">{{value}}</span>
          <span class="card__row--caption">{{caption}}</span>
        </article>
        {{/each}}
      </section>
      {{/if}} {{> modal/modal-runtime}} {{> modal/create-user}}

      <section class="card">
        <div class="card__bar">
          <div class="card__bar-left flex gap-xs">
            <strong>Directory</strong>
            <span class="muted">{{users.length}} people</span>
          </div>
          <div class="card__bar-right">
            <input
              id="user-search"
              class="card__bar-search-input"
              type="search"
              placeholder="Search usersâ€¦"
              autocomplete="off"
            />
          </div>
        </div>

        <div class="card__body">
          <!-- {{#if statusFilters}}
          <div class="users-card__filters" aria-hidden="true">
            {{#each statusFilters}}
            <span class="badge badge--soft badge--tone-{{tone}}"
              >{{label}}</span
            >
            {{/each}}
          </div>
          {{/if}} -->

          <div class="table-wrap">
            <table aria-label="Users">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Roles</th>
                  <th>Status</th>
                  <th>Activity</th>
                  <th>Projects</th>
                  <th class="text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="users-tbody">
                {{#each users}}
                <tr
                  data-id="{{id}}"
                  data-name="{{displayName}}"
                  data-email="{{email}}"
                  data-roles="{{roleLabels}}"
                  data-status="{{status}}"
                >
                  <td>
                    <div class="strong">{{displayName}}</div>
                    <div class="subtle users-table__identity">
                      <span>{{email}}</span>
                      {{#if emailVerified}}
                      <span class="badge badge--soft badge--tone-success"
                        >Verified</span
                      >
                      {{else}}
                      <span class="badge badge--soft">Unverified</span>
                      {{/if}}
                    </div>
                  </td>
                  <td>
                    {{#if hasRoles}}
                    <div class="users-table__roles">
                      <span class="badge badge--soft badge--tone-neutral">
                        {{primaryRoleLabel}}
                      </span>
                      {{#if extraRoleCount}}
                      <span class="badge badge--soft">
                        +{{extraRoleCount}} more
                      </span>
                      {{/if}}
                    </div>
                    {{else}}
                    <span class="subtle">None</span>
                    {{/if}}
                  </td>
                  <td>
                    <span class="badge badge--soft badge--tone-{{statusTone}}">
                      {{statusLabel}}
                    </span>
                  </td>
                  <td>
                    <div class="users-table__meta">
                      <div>
                        Created
                        <time
                          datetime="{{createdAtISO}}"
                          title="{{createdAtDisplay}}"
                        >
                          {{#if createdAtRelative}} {{createdAtRelative}}
                          {{else}} {{createdAtDisplay}} {{/if}}
                        </time>
                      </div>
                      {{#if lastSeenRelative}}
                      <div>
                        Last active
                        <time
                          datetime="{{lastSeenISO}}"
                          title="{{lastSeenDisplay}}"
                        >
                          {{lastSeenRelative}}
                        </time>
                      </div>
                      {{else if inviteSentRelative}}
                      <div>
                        Invite sent
                        <time
                          datetime="{{inviteSentISO}}"
                          title="{{inviteSentDisplay}}"
                        >
                          {{inviteSentRelative}}
                        </time>
                        {{#if inviteExpired}}
                        <span class="badge badge--soft badge--tone-warning"
                          >Expired</span
                        >
                        {{/if}}
                      </div>
                      {{/if}}
                    </div>
                  </td>
                  <td>
                    <span class="subtle">{{projectsSummary}}</span>
                  </td>
                  <td>
                    <div class="row-actions">
                      <button
                        class="chip"
                        aria-label="Edit user"
                        title="Edit user"
                        type="button"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          width="18"
                          height="18"
                          stroke-width="1.5"
                          stroke="currentColor"
                          aria-hidden="true"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                          />
                        </svg>
                      </button>
                      <button
                        class="chip"
                        type="button"
                        aria-label="Manage roles"
                        title="Manage roles"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          width="18"
                          height="18"
                          stroke-width="1.5"
                          stroke="currentColor"
                          aria-hidden="true"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"
                          />
                        </svg>
                      </button>
                      <button
                        class="chip"
                        type="button"
                        aria-label="Manage projects"
                        title="Manage projects"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          width="18"
                          height="18"
                          stroke-width="1.5"
                          stroke="currentColor"
                          aria-hidden="true"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z"
                          />
                        </svg>
                      </button>
                      <button
                        class="chip chip--danger"
                        type="button"
                        data-action="delete"
                        data-id="{{id}}"
                        aria-label="Delete user"
                        title="Delete user"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          width="18"
                          height="18"
                          stroke-width="1.5"
                          stroke="currentColor"
                          aria-hidden="true"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                          />
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
                {{/each}}

                <tr class="empty-row" hidden>
                  <td colspan="6" class="empty">No users found</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <script>
      (() => {
        const input = document.getElementById("user-search");
        const tbody = document.getElementById("users-tbody");
        if (!input || !tbody) return;

        const rows = Array.from(tbody.querySelectorAll("tr[data-id]"));
        const emptyRow = tbody.querySelector(".empty-row");

        const normalize = (s) =>
          (s || "")
            .toString()
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");

        const applyFilter = () => {
          const q = normalize(input.value.trim());
          let visible = 0;

          for (const tr of rows) {
            const haystack = normalize(
              [
                tr.dataset.name,
                tr.dataset.email,
                tr.dataset.roles,
                tr.dataset.status,
              ].join(" "),
            );
            const match = !q || haystack.includes(q);
            tr.hidden = !match;
            if (match) visible++;
          }

          if (emptyRow) emptyRow.hidden = visible !== 0;
        };

        input.addEventListener("input", applyFilter);
        input.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            input.value = "";
            applyFilter();
            e.preventDefault();
          }
        });

        applyFilter();

        document.addEventListener("click", async (event) => {
          const deleteBtn = event.target.closest(
            'button[data-action="delete"]',
          );
          if (!deleteBtn) return;
          const userId = deleteBtn.dataset.id;
          if (!userId) return;
          const row = deleteBtn.closest("tr");
          const name = row?.dataset?.name || "this user";
          const confirmed = window.confirm(
            `Remove ${name}? This action cannot be undone.`,
          );
          if (!confirmed) return;

          deleteBtn.setAttribute("disabled", "true");
          try {
            const resp = await fetch(
              `/api/users/${encodeURIComponent(userId)}`,
              {
                method: "DELETE",
                headers: { Accept: "application/json" },
              },
            );
            if (!resp.ok && resp.status !== 204) {
              const data = await resp.json().catch(() => ({}));
              throw new Error(data?.error || `HTTP ${resp.status}`);
            }
            row?.remove();
            // Trigger filter recalculation to update empty state.
            applyFilter();
          } catch (error) {
            console.error("Failed to delete user:", error);
            window.alert(
              error?.message || "Failed to delete user. Please try again.",
            );
          } finally {
            deleteBtn.removeAttribute("disabled");
          }
        });
      })();
    </script>
  </body>
</html>
